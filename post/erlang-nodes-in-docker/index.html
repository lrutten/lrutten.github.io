<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Erlang nodes in Docker</title>

  <meta name="author" content="" />
  
  

  <meta name="generator" content="Hugo 0.54.0" />

  <link rel="alternate" href="http://eaict.technologiecampusdiepenbeek.be/index.xml" type="application/rss+xml" title="eaict">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="Erlang nodes in Docker" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/post/erlang-nodes-in-docker//" />
  <meta property="og:image" content="" />
  
</head>


  <body>
    <h1>een lange titel</h1>
    
    
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://eaict.technologiecampusdiepenbeek.be/">eaict</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Start" href="/">Start</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Over" href="/page/over/">Over</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Erlang nodes in Docker</h1>
      
      
      
      <span class="post-meta">Gepost op 13-12-2016</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          <p>Gedistribueerde Erlang nodes zijn ook mogelijk in Docker.</p>

<p>Eigenlijk is Docker helemaal niet nodig als je gedistribueerde Erlang nodes wil maken.
Een Erlang node is al een soort container op zich. Maar met de komst van Docker Swarm
zou het wel eens interessant kunnen zijn om de Erlang nodes binnen Docker containers te draaien.</p>

<p>Als je een gedistribueerde Erlang applicatie wil uitbaten dan is Docker Swarm een goed
hulpmiddel. Elke Erlang node draait dan binnen zijn eigen Docker container en elke
Docker container plaatsen we op één Docker node. Deze architectuur heb je nodig als je
rekenintensieve Erlang applicaties maakt. Een goed voorbeeld zijn de mierenkoloniealgoritmes.</p>

<p>In deze post is alleen maar getest of je een Erlang <code>ping</code> kan uitvoeren tussen twee
Erlang nodes die elk een eigen container draaien. Beide containers draaien op dezelfde host.
Voor deze test is een recente Docker versie nodig omdat er <code>docker network</code> wordt gebruikt.
Met dit commando kan je eigen virtuele netwerken beheren. Deze netwerken maken de koppeling
tussen containers toe.</p>

<p>Na enige testen is het gelukt om in Docker Erlang gedistribueerde nodes met elkaar te koppelen.
Elke node draait in een eigen Docker container. De volgende
<a href="https://gist.github.com/lrutten/c13b7124d63fb1e4dd7fa6b8e994dbe6">Dockerfile</a>
maakt de image.</p>

<pre><code>FROM erlang:19.1.6

RUN apt-get update
RUN apt-get install -y dnsutils

EXPOSE 4000-50000

CMD [erl]
</code></pre>

<p>Deze eigen image is nodig. De <code>EXPOSE</code> geeft aan welke poorten binnen deze image toegankelijk moeten zijn.
De daemon <code>epmd</code> draait op poort <code>4369</code> en elke node krijgt dynamisch een poort toegewezen. Deze poorten
zijn niet op voorhand bekend, vandaar de range in de <code>EXPOSE</code>.</p>

<p>Alle Docker commando&rsquo;s staan in de volgende <a href="https://gist.github.com/lrutten/e99a8324c21bc6c288c4ae7d4222ce66">Makefile</a>.</p>

<pre><code>build:
	docker build -t lrutten/erlang .

network-create:
	docker network create lokaal

network-ls:
	docker network ls

erl1:
	docker -D run --name huis1 -it --rm --dns-search=straat.org --net=lokaal -h huis1 --network-alias=huis1.straat.org lrutten/erlang erl -name huis1@huis1.straat.org -setcookie abc

erl2:
	docker -D run --name huis2 -it --rm --dns-search=straat.org --net=lokaal -h huis2 --network-alias=huis2.straat.org lrutten/erlang erl -name huis2@huis2.straat.org -setcookie abc

bash1:
	docker -D run --name huis1 -it --rm --dns-search=straat.org --net=lokaal -h huis1 --network-alias=huis1.straat.org lrutten/erlang /bin/bash

bash2:
	docker -D run --name huis2 -it --rm --dns-search=straat.org --net=lokaal -h huis2 --network-alias=huis2.straat.org lrutten/erlang /bin/bash

stop1:
	docker stop huis1

stop2:
	docker stop huis2

images:
	docker images
</code></pre>

<p>Dit is de werkwijze. Bouw de image.</p>

<pre><code>make build
</code></pre>

<p>Maak dan een netwerk:</p>

<pre><code>make network-create
</code></pre>

<p>Je kan dat netwerk bekijken met:</p>

<pre><code>make network-ls
</code></pre>

<p><code>lokaal</code> is de naam van het netwerk.
Het subnet is dan <code>172.19.0.0/16</code> en de
gateway is dan <code>172.19.0.1/16</code>.</p>

<p>Het voordeel van een eigen netwerk is dat er dan een eigen DNS server beschikbaar is op adres <code>127.0.0.11</code>.
De container gekoppeld met dit netwerk kunnen elkaar dan bereiken via de domeinnaam.
De DNS server kan je testen met <code>dig</code>.</p>

<p>Start de twee containers:</p>

<pre><code>make erl1
make erl2
</code></pre>

<p>Deze containers werken dan interactief. In één van beide start je het <code>ping</code> commando:</p>

<pre><code>Erlang/OTP 19 [erts-8.1.1] [source] [64-bit] [smp:4:4] [async-threads:10] [hipe] [kernel-poll:false]

Eshell V8.1.1  (abort with ^G)
(huis1@huis1.straat.org)1&gt; net_adm:ping('huis2@huis2.straat.org').
pong
(huis1@huis1.straat.org)2&gt; nodes().
['huis2@huis2.straat.org']
</code></pre>

<p>In de andere container zie je dan de <code>nodes()</code>.</p>

<pre><code>Erlang/OTP 19 [erts-8.1.1] [source] [64-bit] [smp:4:4] [async-threads:10] [hipe] [kernel-poll:false]

Eshell V8.1.1  (abort with ^G)
(huis2@huis2.straat.org)1&gt; nodes().
['huis1@huis1.straat.org']
(huis2@huis2.straat.org)2&gt; 
</code></pre>

<p>Door het gebruik van de <code>Makefile</code> heof je niet al die <code>docker run</code> parameters te onthouden.
Voor alle duidelijkheid worden ze hier opgesomd:</p>

<ul>
<li><code>--name huis1</code> dit is de naam van de container</li>
<li><code>-it</code> de container werkt iteratief</li>
<li><code>--rm</code> na het stoppen van de container wordt die verwijderd</li>
<li><code>--dns-search=straat.org</code> zorgt voor de <code>search</code> optie in <code>/etc/resolv.conf</code></li>
<li><code>--net=lokaal</code> deze container wordt in het <code>lokaal</code> netwerk geplaatst</li>
<li><code>-h huis1</code> dit is de hostname</li>
<li><code>--network-alias=huis1.straat.org</code> dit is een extra domeinnaam voor het netwerk. Anders werkt de Linux <code>ping</code> met de FQDN niet.</li>
<li><code>lrutten/erlang</code> de gebruikte image</li>
<li><code>erl -name huis1@huis1.straat.org -setcookie abc</code> de start van de Erlang node, dat kan ook <code>/bin/bash</code> zijn.</li>
</ul>

<p>In de container ziet <code>/etc/resolv.conf</code> er dan zo uit:</p>

<pre><code>search straat.org
nameserver 127.0.0.11
options ndots:0
</code></pre>

<p>Het bestand <code>/etc/resolv.conf</code> heeft zijn eigen mount en komt niet uit de image.
Zo kan je elke container andere instellingen geven ook al werk je met dezelfde image.
Dit geldt ook voor <code>/etc/hostname</code> en <code>/etc/hosts</code>.</p>

<p>Deze links zijn nuttig:</p>

<ul>
<li><a href="https://docs.docker.com/engine/userguide/networking/">https://docs.docker.com/engine/userguide/networking/</a></li>
<li><a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></li>
<li><a href="https://docs.docker.com/engine/userguide/networking/configure-dns/">https://docs.docker.com/engine/userguide/networking/configure-dns/</a></li>
<li><a href="https://docs.docker.com/engine/userguide/networking/default_network/configure-dns/">https://docs.docker.com/engine/userguide/networking/default_network/configure-dns/</a></li>
</ul>
      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="http://eaict.technologiecampusdiepenbeek.be/post/wt-in-docker/" data-toggle="tooltip" data-placement="top" title="Een Wt voorbeeld in Docker">&larr; Vorige post</a>
        </li>
        
        
        <li class="next">
          <a href="http://eaict.technologiecampusdiepenbeek.be/post/cpp-functor/" data-toggle="tooltip" data-placement="top" title="C&#43;&#43; Functors en lambdafuncties">Volgende post &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
		      
		      
		      
	    	  
          
          

    		  <li>
      			<a href="http://eaict.technologiecampusdiepenbeek.be/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  
    		  &nbsp;&bull;&nbsp;
    		  2017
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="http://eaict.technologiecampusdiepenbeek.be/">eaict</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://eaict.technologiecampusdiepenbeek.be/js/jquery-1.11.2.min.js"></script>
<script src="http://eaict.technologiecampusdiepenbeek.be/js/bootstrap.min.js"></script>
<script src="http://eaict.technologiecampusdiepenbeek.be/js/main.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-92842352-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>
</html>
