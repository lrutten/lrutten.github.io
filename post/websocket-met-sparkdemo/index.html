<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Websocket met het Spark Framework</title>

  <meta name="author" content="" />
  
  

  <meta name="generator" content="Hugo 0.54.0" />

  <link rel="alternate" href="http://eaict.technologiecampusdiepenbeek.be/index.xml" type="application/rss+xml" title="eaict">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://eaict.technologiecampusdiepenbeek.be/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="Websocket met het Spark Framework" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/post/websocket-met-sparkdemo//" />
  <meta property="og:image" content="" />
  
</head>


  <body>
    <h1>een lange titel</h1>
    
    
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://eaict.technologiecampusdiepenbeek.be/">eaict</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Start" href="/">Start</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Over" href="/page/over/">Over</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Websocket met het Spark Framework</h1>
      
      
      
      <span class="post-meta">Gepost op 30-10-2015</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          <p>Met het Spark micro framework kan je ook Websocket servers maken.</p>

<p>In dit bericht wordt getoond hoe je met Spark framework een Websocket server kan maken.
Het Spark framework ondersteunt Websockets en de implementatie steunt op die van Jetty.
De volgende link is nuttig om de API te begrijpen.</p>

<ul>
<li><a href="http://www.eclipse.org/jetty/documentation/current/websocket-jetty.html">http://www.eclipse.org/jetty/documentation/current/websocket-jetty.html</a></li>
</ul>

<p>Het voorbeeld is in Java geschreven en wordt gebouwd met Maven. Er is ook
een <code>Dockerfile</code> voorzien zodat je ziet hoe je het voorbeeld ook voor Docker kan bouwen.
Dit kan nuttig zijn als je van plan bent om de serverapp uit te baten bij een cloudprovider.</p>

<p>Het voorbeeld bestaat uit drie Java klassen:</p>

<ul>
<li><code>Main</code></li>
<li><code>Spel</code></li>
<li><code>Speler</code></li>
</ul>

<p>De <code>Main</code> klasse staat hieronder en is verantwoordelijk voor het opstarten van de server.</p>

<pre><code>package be.tcdiepenbeek;

import static spark.Spark.*;

public class Main 
{
   public static void main(String[] args)
   {
      port(5001);
      webSocket(&quot;/echo&quot;, Spel.class);
      get(&quot;/hello&quot;, (req, res) -&gt; &quot;Hello World&quot;);
   }
}
</code></pre>

<p>Hierboven zie je dat er gewacht op clients die zich aanmelden bij poort 5001.
Via het pad <code>/echo</code> kan een verbinding gemaakt worden. De <code>Spel</code> klasse zorgt voor de afhandeling
van binnenkomende verbindingen. De <code>get()</code> regel toont dat je ook statische pagina&rsquo;s kan afhandelen.</p>

<p>In de <code>Spel</code> klasse moet je met <code>@WebSocket</code> aangeven dat deze klasse een Websocketcontroller is.</p>

<pre><code>package be.tcdiepenbeek;

import java.io.IOException;
import java.util.HashMap;

import org.eclipse.jetty.websocket.api.Session;
import org.eclipse.jetty.websocket.api.annotations.*;

@WebSocket
public class Spel
{
   HashMap&lt;Session, Speler&gt; spelers;

   public Spel()
   {
      spelers = new HashMap&lt;Session, Speler&gt;();
   }

   @OnWebSocketConnect
   public void connected(Session session)
   {
      System.out.println(&quot;connected&quot;);
      
      int thisHash = System.identityHashCode(this);
      int sessionHash = System.identityHashCode(session);
      System.out.printf(&quot;   this:   %x\n&quot;, thisHash);
      System.out.printf(&quot;   session:%x\n &quot;, sessionHash);
 
      spelers.put(session, new Speler(this, session));
      System.out.println(&quot;   #spelers &quot; + spelers.size());
   }

   @OnWebSocketClose
   public void closed(Session session, int statusCode, String reason)
   {
      System.out.println(&quot;closed&quot;);
      int thisHash = System.identityHashCode(this);
      int sessionHash = System.identityHashCode(session);
      System.out.printf(&quot;   this:   %x\n&quot;, thisHash);
      System.out.printf(&quot;   session:%x\n &quot;, sessionHash);

      spelers.remove(session);
      System.out.println(&quot;   #spelers &quot; + spelers.size());
   }

   @OnWebSocketMessage
   public void message(Session session, String msg) throws IOException
   {
      System.out.println(&quot;message &quot; + msg);   // Print message

      int thisHash = System.identityHashCode(this);
      int sessionHash = System.identityHashCode(session);
      System.out.printf(&quot;   this:   %x\n&quot;, thisHash);
      System.out.printf(&quot;   session:%x\n &quot;, sessionHash);

      Speler speler = spelers.get(session);
      if (speler != null)
      {
         speler.message(msg);
      }
   }
}
</code></pre>

<p>Voor elke binnenkomende verbindig wordt de <code>connected()</code> methode gestart. Ook hier worden annotaties
gebruikt om aan te geven welke methoden wanneer moeten gestart worden. De <code>closed()</code> methode wordt opgeroepen
als een verbinding verbroken wordt en bij elk binnenkomend bericht door de client vertstuurd wordt
<code>message()</code> gestart. Een belangrijke parameter bij al deze methoden is <code>Session session</code>.
Hiermee wordt de verbinding geïdentificeerd. Al deze sessies worden bijgehouden in een <code>HashMap</code>.
Met elke verbinding wordt een <code>Speler</code> object geassociëerd. De afhandeling van binnenkomende berichten
wordt gedelegeerd naar de betrokken <code>Speler</code>. Dit patroon heeft als voordeel dat binnen de <code>Speler</code> dan
datamembers kunnen bijgehouden worden die de toestand van de speler voorstellen.</p>

<p>Hierboben zie je dan ook dat <code>Spel</code> bij een binnenkomend bericht op zoek gaat naar de betrokken
<code>Speler</code> en aan deze speler het bericht doorgeeft.</p>

<p>Dit is de broncod van de <code>Speler</code>:</p>

<pre><code>package be.tcdiepenbeek;

import java.io.IOException;
import org.eclipse.jetty.websocket.api.Session;

public class Speler
{
   private Spel    spel;
   private Session session;

   public Speler(Spel sp, Session s)
   {
      spel    = sp;
      session = s;
   }

   public void message(String msg) throws IOException
   {
      System.out.println(&quot;Speler message &quot; + msg);   // Print message
      session.getRemote().sendString(&quot;respons &quot; + msg); // and send it back
   }
}
</code></pre>

<p>In de <code>message()</code> methode kan je de specifieke afhandeling van deze speler verder uitschrijven.
Momenteel wordt het ontvangen bericht gewoon teruggestuurd.</p>

<p>Deze 3 klassen vormen een mooie skeletapplicatie waarop verder gebouwd kan worden.
Als client kan je een webpagina in Javascript inzetten. Uiteraard is een Websocket client
ook mogelijk in Android<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>.</p>

<p>Het voorbeeld wordt met Maven gebouwd en dit is de <code>pom.xml</code>
die het project beschrijft.</p>

<pre><code>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;be.tcdiepenbeek&lt;/groupId&gt;
  &lt;artifactId&gt;webapp&lt;/artifactId&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;
  &lt;version&gt;1.0&lt;/version&gt;
  &lt;name&gt;webapp&lt;/name&gt;
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;3.8.1&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.sparkjava&lt;/groupId&gt;
      &lt;artifactId&gt;spark-core&lt;/artifactId&gt;
      &lt;version&gt;2.3&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.4&lt;/version&gt;
        &lt;configuration&gt;
          &lt;finalName&gt;webapp&lt;/finalName&gt;
          &lt;archive&gt;
            &lt;manifest&gt;
              &lt;addClasspath&gt;true&lt;/addClasspath&gt;
              &lt;mainClass&gt;be.tcdiepenbeek.Main&lt;/mainClass&gt;
              &lt;classpathPrefix&gt;dependency-jars/&lt;/classpathPrefix&gt;
            &lt;/manifest&gt;
          &lt;/archive&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;

      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.3&lt;/version&gt;
        &lt;configuration&gt;
          &lt;source&gt;1.8&lt;/source&gt;
          &lt;target&gt;1.8&lt;/target&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;

      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;attached&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;configuration&gt;
              &lt;finalName&gt;webapp&lt;/finalName&gt;
              &lt;descriptorRefs&gt;
                &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
              &lt;/descriptorRefs&gt;
              &lt;archive&gt;
                &lt;manifest&gt;
                  &lt;mainClass&gt;be.tcdiepenbeek.Main&lt;/mainClass&gt;
                &lt;/manifest&gt;
              &lt;/archive&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;

    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;
</code></pre>

<p>Deze <code>pom.xml</code> is in staat om het <code>.jar</code> archief te bouwen.
Gemakkelijkheidshalve is hier nog een <code>Makefile</code> die alle <code>mvn</code> commando&rsquo;s
bijhoudt.</p>

<pre><code>package:
	mvn compile package

clean:
	mvn clean

run:
	java -jar target/webapp-jar-with-dependencies.jar


dockerbuild:
	docker build -t lrutten/sparkwebapp .


dockerrun:
	docker run -d -p 5001:5001 lrutten/sparkwebapp
</code></pre>

<p>Zoals je ziet, is er ook een <code>Dockerfile</code> voorzien zodat
de applicatie in Docker kan getest worden. Deze <code>Dockerfile</code> vertrekt van een Java 8 image
en voert de compilatie volledig uit.</p>

<pre><code>FROM java:8 

# Install maven
RUN apt-get update
RUN apt-get install -y maven

# Prepare by downloading dependencies
ADD pom.xml /code/pom.xml
RUN [&quot;mvn&quot;, &quot;dependency:resolve&quot;]
RUN [&quot;mvn&quot;, &quot;verify&quot;]

# Adding source, compile and package into a fat jar
ADD src /code/src
RUN [&quot;mvn&quot;, &quot;package&quot;]

EXPOSE 5001
CMD [&quot;/usr/lib/jvm/java-8-openjdk-amd64/bin/java&quot;, &quot;-jar&quot;, &quot;target/webapp-jar-with-dependencies.jar&quot;]
</code></pre>

<p>De applicatie is dan toegankelijk via poort 5001.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Dit is al eens getest.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="http://eaict.technologiecampusdiepenbeek.be/post/slackware-14-1/" data-toggle="tooltip" data-placement="top" title="Slackware 14.1 is er">&larr; Vorige post</a>
        </li>
        
        
        <li class="next">
          <a href="http://eaict.technologiecampusdiepenbeek.be/post/labo-lambda/" data-toggle="tooltip" data-placement="top" title="C&#43;&#43;11 Lambdafuncties">Volgende post &rarr;</a>
        </li>
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
		      
		      
		      
	    	  
          
          

    		  <li>
      			<a href="http://eaict.technologiecampusdiepenbeek.be/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  
    		  &nbsp;&bull;&nbsp;
    		  2017
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="http://eaict.technologiecampusdiepenbeek.be/">eaict</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://eaict.technologiecampusdiepenbeek.be/js/jquery-1.11.2.min.js"></script>
<script src="http://eaict.technologiecampusdiepenbeek.be/js/bootstrap.min.js"></script>
<script src="http://eaict.technologiecampusdiepenbeek.be/js/main.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-92842352-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>
</html>
